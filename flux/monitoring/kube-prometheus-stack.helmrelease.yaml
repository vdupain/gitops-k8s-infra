---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: prometheus
  namespace: monitoring
spec:
  chart:
    spec:
      chart: kube-prometheus-stack
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      version: 58.4.0
  interval: 5m

  values:
    prometheus:
      prometheusSpec:
        additionalScrapeConfigs:
          - job_name: "opnsense"
            static_configs:
            - targets: ["http://opnsense.home:9100/metrics"]
          - job_name: blackbox
              metrics_path: /probe
              params:
                module: [http_2xx]
              static_configs:
                # Add URLs as target parameter
                - targets:
                  - https://opnsense.home/
              relabel_configs:
              - source_labels: [__address__]
                target_label: __param_target
              - source_labels: [__param_target]
                # Important!     
                target_label: target
                # Ensure blackbox-exporter is reachable from Prometheus
              - target_label: __address__ 
                replacement: prometheus-blackbox-exporter.monitoring:9115
        # additionalScrapeConfigsSecret:
        #   name: additional-scrape-configs
        #   key: prometheus-additional.yaml
    alertmanager:
      enabled: false
  
